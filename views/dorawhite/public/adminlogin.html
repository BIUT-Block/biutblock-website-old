<!--用户登录模块-->
<div class="loginBoard" ms-controller="userlogin">
    <form name="loginForm" ms-validate="@validate">
        <h3>管理员登录 &nbsp;
            <small class="text-danger" :visible="@showErr" ms-html="@message"></small>
        </h3>
        <div class="form-group">
            <input type="text" class="form-control" name="userName" ms-duplex="@userName" placeholder="请填写用户名" ms-rules="{required:true, pattern: /^[a-zA-Z][a-zA-Z0-9_]{4,11}$/ }"
                data-required-message="用户名不能为空" data-message="请填写正确的用户名">
        </div>
        <div class="form-group">
            <input type="password" class="form-control" name="password" placeholder="请输入密码" ms-duplex="@password" ms-rules="{required: true,pattern: /(?!^\\d+$)(?!^[a-zA-Z]+$)(?!^[_#@]+$).{5,}/}"
                data-required-message="请输入密码" data-message="6-12位，只能包含字母、数字和下划线">
        </div>
        <div id="ul-s5">
            <button type="submit" class="btn btn-default">登录</button>&nbsp;
        </div>
    </form>
</div>

<script>
    var loginVm = avalon.define({
        $id: 'userlogin',
        password: '',
        userName: '',
        message: '',
        showErr: false,
        validate: {
            onError: function (reasons) {
                reasons.forEach(function (reason) {
                    console.log(reason.getMessage())
                })
            },
            onValidateAll: function (reasons) {
                if (reasons.length) {
                    console.log('有表单没有通过', reasons)
                    loginVm.showErr = true;
                    loginVm.message = reasons[0].message;
                } else {
                    console.log('全部通过');
                    var params = {
                        userName: loginVm.userName,
                        password: CryptoJS.MD5('dora'+loginVm.password).toString()
                    }
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8', // 很重要
                        traditional: true,
                        data: JSON.stringify(params),
                        url: 'api/admin/doLogin',
                        success: function (data) {
                            console.log('success:', data)
                            if (data.state == 'success') {
                                window.location.href = "/manage";
                            } else {
                                loginVm.showErr = true;
                                loginVm.message = data.message;
                            }
                        },
                        error: function (d) {
                            console.log('error:', d)
                        }
                    })
                }
            }
        }
    })
</script>