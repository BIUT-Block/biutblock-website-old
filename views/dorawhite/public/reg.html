<!--用户注册模块-->
<div class="regBoard" ms-controller="reglogin">
    <form name="loginForm" ms-validate="@validate">
        <h3>用户注册 &nbsp;
            <small class="text-danger" :visible="@showErr" ms-html="@message"></small>
        </h3>
        <div class="form-group">
            <input type="text" class="form-control" name="userName" ms-duplex="@userName" placeholder="请填写用户名" ms-rules="{required:true, pattern: /^[a-zA-Z][a-zA-Z0-9_]{4,11}$/ }"
                data-required-message="用户名不能为空" data-message="用户名5-12个英文数字组合">
        </div>
        <div class="form-group">
            <input type="email" class="form-control" name="email" ms-duplex="@email" placeholder="请填写邮箱" ms-rules="{required:true, pattern: /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/ }"
                data-required-message="邮箱不能为空" data-message="请填写正确的邮箱地址">
        </div>
        <div class="form-group">
            <input type="password" class="form-control" name="password" placeholder="请输入密码" ms-duplex="@password" ms-rules="{required: true,pattern: /(?!^\\d+$)(?!^[a-zA-Z]+$)(?!^[_#@]+$).{5,}/}"
                data-required-message="请输入密码" data-message="6-12位，只能包含字母、数字和下划线">
        </div>
        <div class="form-group">
                <input type="password" class="form-control" name="confirmPassword" placeholder="请确认密码" ms-duplex="@confirmPassword  | change" ms-rules="{required: true,,equalto:'password'}"
                    data-required-message="请确认密码" data-message="两次输入密码不一致">
            </div>
        <div id="ul-s5">
            <button type="submit" class="btn btn-default">登录</button>&nbsp;
            <small>
                <a href="/users/lostPassword">忘记密码？</a>
            </small>
        </div>
    </form>
</div>

<script>
    var regVm = avalon.define({
        $id: 'reglogin',
        userName:'',
        password: '',
        confirmPassword: '',
        email: '',
        message: '',
        showErr: false,
        validate: {
            onError: function (reasons) {
                reasons.forEach(function (reason) {
                    console.log(reason.getMessage())
                })
            },
            onValidateAll: function (reasons) {
                if (reasons.length) {
                    console.log('有表单没有通过', reasons)
                    regVm.showErr = true;
                    regVm.message = reasons[0].message;
                } else {
                    console.log('全部通过');
                    var params = {
                        userName: regVm.userName,
                        email: regVm.email,
                        password: regVm.password,
                        confirmPassword: regVm.confirmPassword
                    }
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8', // 很重要
                        traditional: true,
                        data: JSON.stringify(params),
                        url: '/users/doReg',
                        success: function (data) {
                            console.log('success:', data)
                            if (data.state == 'success') {
                                window.location.href = "/";
                            } else {
                                regVm.showErr = true;
                                regVm.message = data.message;
                            }
                        },
                        error: function (d) {
                            console.log('error:', d)
                        }
                    })
                }
            }
        }
    })
</script>