<!--用户登录模块-->
<div class="loginBoard" ms-controller="userlogin">
    <form name="loginForm" ms-validate="@validate">
        <h3>用户登录 &nbsp;
            <small class="text-danger" :visible="@showErr" ms-html="@message"></small>
        </h3>
        <div class="form-group">
            <input type="email" class="form-control" name="email" ms-duplex="@email" placeholder="请填写邮箱" ms-rules="{required:true, pattern: /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/ }"
                data-required-message="邮箱不能为空" data-message="请填写正确的邮箱地址">
        </div>
        <div class="form-group">
            <input type="password" class="form-control" name="password" placeholder="请输入密码" ms-duplex="@password" ms-rules="{required: true,pattern: /(?!^\\d+$)(?!^[a-zA-Z]+$)(?!^[_#@]+$).{5,}/}"
                data-required-message="请输入密码" data-message="6-12位，只能包含字母、数字和下划线">
        </div>
        <div id="ul-s5">
            <button type="submit" class="btn btn-default">登录</button>&nbsp;
            <small>
                <a href="/users/lostPassword">忘记密码？</a>
            </small>
        </div>
    </form>
</div>

<script>
    var loginVm = avalon.define({
        $id: 'userlogin',
        password: '',
        email: '',
        message: '',
        showErr: false,
        validate: {
            onError: function (reasons) {
                reasons.forEach(function (reason) {
                    console.log(reason.getMessage())
                })
            },
            onValidateAll: function (reasons) {
                if (reasons.length) {
                    console.log('有表单没有通过', reasons)
                    loginVm.showErr = true;
                    loginVm.message = reasons[0].message;
                } else {
                    console.log('全部通过');
                    var params = {
                        email: loginVm.email,
                        password: loginVm.password
                    }
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8', // 很重要
                        traditional: true,
                        data: JSON.stringify(params),
                        url: '/users/doLogin',
                        success: function (data) {
                            console.log('success:', data)
                            if (data.state == 'success') {
                                window.location.href = "/";
                            } else {
                                loginVm.showErr = true;
                                loginVm.message = data.message;
                            }
                        },
                        error: function (d) {
                            console.log('error:', d)
                        }
                    })
                }
            }
        }
    })
</script>